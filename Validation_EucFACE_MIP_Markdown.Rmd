---
title: "EucFACE Simulation Output Validation"
author: "Mingkai Jiang"
date: "1/4/2021"
output: pdf_document
#fig_width: 3 
#fig_height: 2 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=6, fig.height=4)


#### clear wk space
rm(list=ls(all=TRUE))

#### Source functions and packages
source("prepare.R")

#### select the model abbreviation
#### options are:
####             GDAYN: GDAY, CN version
####             GDAYP: GDAY, CNP version
####             QUNIC: QUINCY
####             OCHDP: ORCHIDEE, CNP version
####             OCHDN: ORCHIDEE, CN version
####             LPJGN: LPJ-Guess, CN version
####             LPJGP: LPJ-Guess, CNP version
####             CABLP: CABLE-POP, CNP version
####             ELMXX: ELM, CNP version

mod.abb <- "GDAYP"


```

## Introduction

This is an R Markdown document to evaluate the model simulation results for the new EucFACE multi-model intercomparison project, based on mass balance checks and validation datasets. 

To use this Markdown, please create two folders within this repository and place the relevant data files into each folder. 

- Create a folder "simulation_output", and place the model simulation results into this folder (note, only the file containing ambient treatment over the period of 2012 - 2019).

- Create a folder "validation_dataset", and place the validation datasets into this folder (data can be obtained via the CloudStor link sent previously).


This script will firstly check some basic mass balances, the compare the simulation results against some time-invariant parameters provided in the parameter list, and finally check several time-series variables. All checks are performed for ambient CO2 treatment only. 



```{r, echo=FALSE, message=FALSE, warning=FALSE}
### read in simulation results and get it in shape for comparison.
### the naming of the file follows rules identified in the output protocol. 
### Note that this is the daily file. 
modDF <- read.csv(paste0("simulation_output/EUC_", mod.abb, "_OBS_VAR_AMB_NOP_D.csv"),
                  skip=1)

### checking number of column in the original dataframe
ncol <- ncol(modDF)
#print(paste0("no. of columns is ", ncol))

### add date to the dataset
for (i in 2012:2019) {
    
    date.list <- as.Date((modDF$doy[modDF$year==i]-1), 
                                           origin = paste0(i, "-01-01"))
    
    modDF$Date[modDF$year == i] <- as.character(date.list)
}

modDF$Date <- as.Date(modDF$Date)



### revise the GDAY output names following output protocol (delete this once GDAY output is properly set)
names(modDF)[names(modDF) == "lai"] <- "LAI"
names(modDF)[names(modDF) == "hetero_resp"] <- "RHET"

### add extra column where GDAY simulation doesn't output for now
# coarse root respiration
modDF$RCR <- 0.0

# fine root respiration
modDF$RFR <- 0.0


### convert unit from current GDAY default of t ha-1 to whatever is defined in the output protocol
modDF$RHET <- with(modDF, RHET * 100)
modDF$RFR <- with(modDF, RFR * 100)
modDF$RCR <- with(modDF, RCR * 100)


```


## Checking mass balance

#### Net Ecosystem Production (NEP)

We define NEP as: NEP = GPP - Reco - Offsite C losses

More to be added. Do parameters first. 



## Checking time-invariant parameters, fluxes and stocks against validation data




## Checking time-varying variables against validation data

#### Leaf area index

A time series LAI data over the period of 2012 - 2016 was provided for validation purpose. Models should aim to match the magnitude of LAI as well as its temporal patterns. 

The temporal pattern based on all available data is provided in the figure below:

```{r, echo=FALSE, message=FALSE, warning=FALSE}

### validation LAI
laiDF <- read.csv("validation_dataset/EucFACE_LAI_2012_2016.csv")
laiDF <- laiDF[laiDF$Trt=="aCO2",]
laiDF$Date <- as.Date(as.character(laiDF$Date))

### simulated LAI, subset
subDF <- subset(modDF, year <= 2016)
subDF <- subDF[,c("year", "doy", "Date", "LAI")]
subDF$Date <- as.Date(as.character(subDF$Date))

### merge the two dataset
testDF1 <- merge(subDF, laiDF, by="Date", all=T)

### plot all data
p1 <- ggplot(testDF1, aes(x=Date)) +
        geom_errorbar(aes(ymin=lai-laiSD,
                        ymax=lai+laiSD, color="obs"))+
        geom_line(aes(y=LAI, color="sim"), lwd = 1) +
        theme_linedraw() +
        theme(panel.grid.minor=element_blank(),
              axis.title.x = element_text(size=14), 
              axis.text.x = element_text(size=12),
              axis.text.y=element_text(size=12),
              axis.title.y=element_text(size=14),
              legend.text=element_text(size=12),
              legend.title=element_text(size=12),
              panel.grid.major=element_blank(),
              plot.title = element_text(size = 10, face = "bold"),
              legend.position="right")+
        ylab("LAI")+
        scale_colour_manual("", 
                            values = c("obs"="black", "sim"="red2"),
                            labels = c("Observed", "Simulated"))

    plot(p1)
    

```

Now we can check the goodness-of-fit of all days where observation is available. A perfect fit should have slope of 1 and intercept of 0. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}

### subset only days where observations are available
testDF2 <- testDF1[complete.cases(testDF1$lai),]

lm.fit <- lm(testDF2$LAI~testDF2$lai)


### plot all data
p1 <- ggplot(testDF2, aes(x=lai, y=LAI)) +
        geom_point()+
        theme_linedraw() +
        geom_smooth(method="lm")+
        theme(panel.grid.minor=element_blank(),
              axis.title.x = element_text(size=14), 
              axis.text.x = element_text(size=12),
              axis.text.y=element_text(size=12),
              axis.title.y=element_text(size=14),
              legend.text=element_text(size=12),
              legend.title=element_text(size=12),
              panel.grid.major=element_blank(),
              plot.title = element_text(size = 10, face = "bold"),
              legend.position="right")+
        ylab("simulated LAI")+
        xlab("observed LAI")

    plot(p1)
    

```

The linear fit results are: 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
print(paste0("slope = ", round(coef(lm.fit)[2], 2)))
print(paste0("intercept = ", round(coef(lm.fit)[1], 2)))

```



#### Soil respiration
The measured soil respiration rate represents both root and soil heterotrophic respiration flux. It was up-scaled from the LICOR chambers by averaging all measurements within the same treatment. It was a model product, in that we used DAMM model to establish relationship with soil temperature, and then obtained the daily rate throughout the year. Nevertheless, we expect modelers to provide a good match simulation to this dataset. 

Note that we didn't ask the modelers to output soil respiration flux in the output protocol. Please add heterotrophic respiration and root respiration to obtain soil respiration flux. Also, please note that, the unit for all carbon fluxes is given in the output protocol, as gC m-2 d-1. 


```{r, echo=FALSE, message=FALSE, warning=FALSE}

### validation Rsoil
rsoilDF <- read.csv("validation_dataset/EucFACE_daily_soil_respiration_flux_2013_2015.csv")
rsoilDF <- rsoilDF[rsoilDF$Trt=="aCO2",]
rsoilDF$Date <- as.Date(as.character(rsoilDF$Date))

### convert unit, from mg m-2 d-1 to g m-2 d-1
rsoilDF$Rsoil_g_m2_d <- rsoilDF$Rsoil_mg_m2_d / 1000.0
rsoilDF$RsoilSD_g <- rsoilDF$RsoilSD / 1000.0


### simulated Rsoil, subset
subDF <- subset(modDF, year <= 2015 & year > 2012)
subDF <- subDF[,c("year", "doy", "Date", "RHET", "RCR", "RFR")]
subDF$Date <- as.Date(as.character(subDF$Date))
subDF$Rsoil_sim <- with(subDF, RHET+RCR+RFR)



### merge the two dataset
testDF1 <- merge(subDF, rsoilDF, by="Date", all=T)

### plot all data
p1 <- ggplot(testDF1, aes(x=Date)) +
        geom_errorbar(aes(ymin=Rsoil_g_m2_d-RsoilSD_g,
                        ymax=Rsoil_g_m2_d+RsoilSD_g, color="obs"))+
        geom_line(aes(y=Rsoil_sim, color="sim"), lwd = 1) +
        theme_linedraw() +
        theme(panel.grid.minor=element_blank(),
              axis.title.x = element_text(size=14), 
              axis.text.x = element_text(size=12),
              axis.text.y=element_text(size=12),
              axis.title.y=element_text(size=14),
              legend.text=element_text(size=12),
              legend.title=element_text(size=12),
              panel.grid.major=element_blank(),
              plot.title = element_text(size = 10, face = "bold"),
              legend.position="right")+
        ylab("Soil respiration flux")+
        scale_colour_manual("", 
                            values = c("obs"="black", "sim"="red2"),
                            labels = c("Observed", "Simulated"))

    plot(p1)
    


```


#### Soil water content
Soil water content is more complex and non-linear, depending on many model-specific settings. The validation dataset only serves as a guidance to evaluate your model performance. 


```{r, echo=FALSE, message=FALSE, warning=FALSE}

### validation Rsoil
swcDF <- read.csv("validation_dataset/EucFACE_SWC_2012_2019.csv")

### more to be filled. 


```

End. 